# –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ SQL Server —Å –ø–æ–º–æ—â—å—é Apache Airflow

![Apache Airflow](https://img.shields.io/badge/Apache%20Airflow-017CEE?style=for-the-badge&logo=Apache%20Airflow&logoColor=white)
![Docker](https://img.shields.io/badge/Docker-2496ED?style=for-the-badge&logo=docker&logoColor=white)
![SQL Server](https://img.shields.io/badge/Microsoft%20SQL%20Server-CC2927?style=for-the-badge&logo=microsoft%20sql%20server&logoColor=white)

–ü—Ä–æ–µ–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV/XLSX/XLSB —Ñ–∞–π–ª–æ–≤ –≤ Microsoft SQL Server —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Apache Airflow. –†–µ—à–µ–Ω–∏–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–∫–≤–æ–∑–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö –æ—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –¥–æ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ä–æ–∑–Ω–∏—á–Ω—ã—Ö —Å–µ—Ç–µ–π

## üåü –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è XLSX ‚Üí CSV
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ SQL Server
- –ü–∞–∫–µ—Ç–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- –î–∏–Ω–∞–º–∏—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º—É–ª—å—Ç–∏—Å–µ—Ç–µ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã

## üì¶ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Docker Desktop 20.10+
- Docker Compose 2.0+
- Microsoft SQL Server 2019+
- 4 –ì–ë —Å–≤–æ–±–æ–¥–Ω–æ–π –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
1. **–ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:**
```bash
git clone https://github.com/BogdanG888G/Automatization.git
cd airflow-data-pipeline
```

2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ:**
```bash
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª –ø–æ–¥ –≤–∞—à—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
```

3. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç:**
```bash
docker-compose up -d --build
```

4. **–î–æ—Å—Ç—É–ø –∫ Airflow UI:**
```
http://localhost:8080
```
–õ–æ–≥–∏–Ω: `airflow`  
–ü–∞—Ä–æ–ª—å: `airflow`

5. **–ü–æ–º–µ—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
```bash
# –ü—Ä–∏–º–µ—Ä –¥–ª—è Magnit
cp –≤–∞—à_—Ñ–∞–π–ª.csv ./data/magnit_december_2024.csv
```

## üóÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
AUTOMATIZATION/
‚îú‚îÄ‚îÄ archive/                  # –ê—Ä—Ö–∏–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
‚îú‚îÄ‚îÄ data/                     # –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
‚îú‚îÄ‚îÄ dags/                     # –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ DAG –¥–ª—è –∫–∞–∂–¥–æ–π —Å–µ—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ ashan_sales_pipeline.py
‚îÇ   ‚îú‚îÄ‚îÄ diksi_sales_pipeline.py
‚îÇ   ‚îú‚îÄ‚îÄ magnit_sales_pipeline.py
‚îÇ   ‚îú‚îÄ‚îÄ okey_sales_pipeline.py
‚îÇ   ‚îú‚îÄ‚îÄ perekrestok_sales_pipeline.py
‚îÇ   ‚îú‚îÄ‚îÄ pyaterochka_sales_pipeline.py
‚îÇ   ‚îî‚îÄ‚îÄ x5_sales_pipeline.py
‚îú‚îÄ‚îÄ scripts/                  # –°–µ—Ç–µ–≤—ã–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ ashan/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ convert_raw_to_stage.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ create_table_and_upload.py
‚îÇ   ‚îú‚îÄ‚îÄ diksi/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ convert_raw_to_stage.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ create_table_and_upload.py
‚îÇ   ‚îú‚îÄ‚îÄ magnit/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ convert_raw_to_stage.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ create_table_and_upload.py
‚îÇ   ‚îú‚îÄ‚îÄ okey/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ convert_raw_to_stage.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ create_table_and_upload.py
‚îÇ   ‚îú‚îÄ‚îÄ perekrestok/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ convert_raw_to_stage.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ create_table_and_upload.py
‚îÇ   ‚îú‚îÄ‚îÄ pyaterochka/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ convert_raw_to_stage.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ create_table_and_upload.py
‚îÇ   ‚îî‚îÄ‚îÄ x5/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ convert_raw_to_stage.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ create_table_and_upload.py
‚îÇ   ‚îî‚îÄ‚îÄ common/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ convert_xlsx_to_csv.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.py                # –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã
‚îú‚îÄ‚îÄ .dockerignore
‚îú‚îÄ‚îÄ .env                      # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ config.py
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ TODO.md
‚îú‚îÄ‚îÄ entrypoint.sh
‚îî‚îÄ‚îÄ README.md
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MSSQL
1. –í Airflow UI: **Admin ‚Üí Variables**
2. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é:
   - **Key**: `MSSQL_CONN_STR`
   - **Value**:
```
mssql+pyodbc://<user>:<password>@<host>/<database>?driver=ODBC+Driver+17+for+SQL+Server
```

–ü—Ä–∏–º–µ—Ä –¥–ª—è Windows:
```
mssql+pyodbc://airflow_agent:Pass123@host.docker.internal/SalesDB?driver=ODBC+Driver+17+for+SQL+Server&Encrypt=yes&TrustServerCertificate=yes
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è DAG
–û—Å–Ω–æ–≤–Ω–æ–π DAG –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
```python
with DAG(
    dag_id="retail_data_pipeline",
    start_date=datetime(2025, 1, 1),
    schedule_interval="@daily",  # –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∑–∞–ø—É—Å–∫
    catchup=False,
    tags=["retail", "data_processing"],
) as dag:
```

## üìä –§–æ—Ä–º–∞—Ç—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–æ–∑–Ω–∏—á–Ω—ã—Ö —Å–µ—Ç–µ–π

### üõí Magnit
```sql
CREATE TABLE [Stage].[magnit].[magnit_<–º–µ—Å—è—Ü>_<–≥–æ–¥>] (
    [month] NVARCHAR(50),
    [format] NVARCHAR(50),
    [store_name] NVARCHAR(255),
    [store_id] INT,
    [store_address] NVARCHAR(500),
    [level_1] NVARCHAR(255),
    [level_2] NVARCHAR(255),
    [level_3] NVARCHAR(255),
    [level_4] NVARCHAR(255),
    [supplier] NVARCHAR(255),
    [brand] NVARCHAR(255),
    [product_name] NVARCHAR(255),
    [product_id] NVARCHAR(50),
    [barcode] NVARCHAR(50),
    [revenue_rub] DECIMAL(18,2),
    [revenue_qty] INT,
    [purchase_price] DECIMAL(18,2)
```

### üõí Ashan
```sql
CREATE TABLE [Stage].[ashan].[ashan_<–º–µ—Å—è—Ü>_<–≥–æ–¥>] (
    [date_raw] DATE,
    [product_name] NVARCHAR(255),
    [store] NVARCHAR(255),
    [city] NVARCHAR(100),
    [address] NVARCHAR(500),
    [month_raw] NVARCHAR(50),
    [—Å—Ä_—Ü–µ–Ω–∞_–ø—Ä–æ–¥–∞–∂–∏] DECIMAL(18,2),
    [—Å–ø–∏—Å–∞–Ω–∏—è_—Ä—É–±] DECIMAL(18,2),
    [—Å–ø–∏—Å–∞–Ω–∏—è_—à—Ç] INT,
    [–ø—Ä–æ–¥–∞–∂–∏_c_–Ω–¥—Å] DECIMAL(18,2),
    [–ø—Ä–æ–¥–∞–∂–∏_—à—Ç] INT,
    [—Å—Ä_—Ü–µ–Ω–∞_–ø–æ–∫—É–ø–∫–∏] DECIMAL(18,2),
    [–º–∞—Ä–∂–∞_—Ä—É–±] DECIMAL(18,2),
    [–ø–æ—Ç–µ—Ä–∏_—Ä—É–±] DECIMAL(18,2),
    [–ø–æ—Ç–µ—Ä–∏_—à—Ç] INT,
    [–ø—Ä–æ–º–æ_–ø—Ä–æ–¥–∞–∂–∏_c_–Ω–¥—Å] DECIMAL(18,2),
    [sale_month] INT,
    [sale_year] INT,
    [sale_date] DATE,
    [product_segment] NVARCHAR(100),
    [product_family_code] NVARCHAR(50),
    [product_family_name] NVARCHAR(255),
    [product_article] NVARCHAR(50),
    [supplier_code] NVARCHAR(50),
    [supplier_name] NVARCHAR(255),
    [store_format] NVARCHAR(50)
```

### üõí Diksi
```sql
CREATE TABLE [Stage].[diksi].[diksi_<–º–µ—Å—è—Ü>_<–≥–æ–¥>] (
    [sale_year] INT,
    [sale_month] INT,
    [level_3] NVARCHAR(255),
    [level_4] NVARCHAR(255),
    [level_5] NVARCHAR(255),
    [vtm] NVARCHAR(255),
    [product] NVARCHAR(255),
    [address] NVARCHAR(500),
    [product_code] NVARCHAR(50),
    [stores] NVARCHAR(255),
    [quantity_first_week] INT,
    [cost_with_vat_first_week] DECIMAL(18,2),
    [amount_with_vat_first_week] DECIMAL(18,2),
    [quantity_second_week] INT,
    [cost_with_vat_second_week] DECIMAL(18,2),
    [amount_with_vat_second_week] DECIMAL(18,2),
    [quantity_third_week] INT,
    [cost_with_vat_third_week] DECIMAL(18,2),
    [amount_with_vat_third_week] DECIMAL(18,2),
    [quantity_fourth_week] INT,
    [cost_with_vat_fourth_week] DECIMAL(18,2),
    [amount_with_vat_fourth_week] DECIMAL(18,2),
    [quantity_fifth_week] INT,
    [cost_with_vat_fifth_week] DECIMAL(18,2),
    [amount_with_vat_fifth_week] DECIMAL(18,2),
    [quantity_summary] INT,
    [cost_with_vat_summary] DECIMAL(18,2),
    [amount_with_vat_summary] DECIMAL(18,2)
```

### üõí Okey
```sql
CREATE TABLE [Stage].[okey].[okey_<–º–µ—Å—è—Ü>_<–≥–æ–¥>] (
    [retail_chain] NVARCHAR(50),
    [product_category] NVARCHAR(255),
    [product_type] NVARCHAR(255),
    [supplier_name] NVARCHAR(255),
    [brand] NVARCHAR(255),
    [product_name] NVARCHAR(255),
    [product_unified_name] NVARCHAR(255),
    [product_weight_g] INT,
    [product_flavor] NVARCHAR(100),
    [sales_quantity] INT,
    [sales_amount_rub] DECIMAL(18,2),
    [sales_weight_kg] DECIMAL(18,3),
    [cost_price_rub] DECIMAL(18,2),
    [sales_month] INT,
    [load_dt] DATETIME
```

### üõí Pere–∫restok
```sql
CREATE TABLE [Stage].[perekrestok].[perekrestok_<–º–µ—Å—è—Ü>_<–≥–æ–¥>] (
    [period] DATE,
    [retail_chain] NVARCHAR(50),
    [category] NVARCHAR(255),
    [supplier] NVARCHAR(255),
    [brand] NVARCHAR(255),
    [product_name] NVARCHAR(255),
    [weight_g] INT,
    [flavor] NVARCHAR(100),
    [sale_year] INT,
    [sale_month] INT,
    [cost_rub] DECIMAL(18,2),
    [sales_qty] INT,
    [sales_rub] DECIMAL(18,2),
    [sales_tons] DECIMAL(18,3),
    [category_lvl2] NVARCHAR(255),
    [product_name_uni] NVARCHAR(255)
```

### üõí Pyaterochka
```sql
CREATE TABLE [Stage].[pyaterochka].[pyaterochka_<–º–µ—Å—è—Ü>_<–≥–æ–¥>] (
    [retail_chain] NVARCHAR(50),
    [brand] NVARCHAR(255),
    [product_name] NVARCHAR(255),
    [sales_quantity] INT,
    [sales_amount_rub] DECIMAL(18,2),
    [sales_weight_kg] DECIMAL(18,3),
    [cost_price_rub] DECIMAL(18,2),
    [sales_month] INT,
    [product_category] NVARCHAR(255),
    [product_type] NVARCHAR(255),
    [supplier_name] NVARCHAR(255),
    [product_unified_name] NVARCHAR(255),
    [product_weight_g] INT,
    [product_flavor] NVARCHAR(100),
    [load_dt] DATETIME
```

### üõí X5 Retail Group
```sql
CREATE TABLE [Stage].[x5].[x5_<–º–µ—Å—è—Ü>_<–≥–æ–¥>] (
    [retail_chain] NVARCHAR(50),
    [branch] NVARCHAR(255),
    [region] NVARCHAR(100),
    [city] NVARCHAR(100),
    [address] NVARCHAR(500),
    [factory] NVARCHAR(255),
    [factory_2] NVARCHAR(255),
    [prod_level_2] NVARCHAR(255),
    [prod_level_3] NVARCHAR(255),
    [prod_level_4] NVARCHAR(255),
    [material] NVARCHAR(255),
    [material_2] NVARCHAR(255),
    [brand] NVARCHAR(255),
    [vendor] NVARCHAR(255),
    [main_supplier] NVARCHAR(255),
    [warehouse_supplier] NVARCHAR(255),
    [quantity] INT,
    [gross_turnover] DECIMAL(18,2),
    [gross_cost] DECIMAL(18,2),
    [avg_cost_price] DECIMAL(18,2),
    [avg_sell_price] DECIMAL(18,2),
    [sale_month] INT,
    [sale_year] INT
```

## üîÑ –†–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å
```mermaid
graph TD
    A[Scan ./data directory] --> B{New file found?}
    B -->|Yes| C[Determine retail chain]
    B -->|No| Z[End process]
    C --> D[Convert XLSX to CSV]
    D --> E[Create SQL table]
    E --> F[Upload data to Test base]
    F --> G[Modify data with new types (INT, DECIMAL, NVARCHAR)]
    G --> H[Upload data to Stage base]
    H --> I[Move file to archive]
    I --> J[Log success]
```

## üêõ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫
**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:**
```bash
docker-compose logs -f airflow-worker
```


**–ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞:**
```bash
docker-compose down --volumes --remove-orphans
docker-compose build --no-cache
docker-compose up -d
```

**–û—á–∏—Å—Ç–∫–∞ Docker:**
```bash
docker system prune -a --volumes
```
